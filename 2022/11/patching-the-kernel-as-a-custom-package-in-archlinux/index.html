<!doctype html><html lang=en-us data-theme><head><meta charset=utf-8><meta name=HandheldFriendly content="True"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer-when-downgrade"><title>Patching the kernel as a custom package in Archlinux - manueljimenezs</title><meta name=description content="Following the adventure of patching the linux kernel, I tried to automate it a bit. Part of the process is well documented as always in the wiki
The idea is to fetch the official Archlinux sources for the linux kernel so we can modify them and add our patches.
  Could I buy a graphics card with a normal HDMI port for a hundred bucks and skip all of this mess?"><link rel=icon type=image/x-icon href=https://manueljimenezs.github.io/favicon.ico><link rel=apple-touch-icon-precomposed href=https://manueljimenezs.github.io/favicon.png><style>body{visibility:hidden;opacity:0}</style><noscript><style>body{visibility:visible;opacity:1}</style></noscript><script>const checkbox=document.getElementById("checkbox");checkbox.addEventListener("change",()=>{document.body.classList.toggle("dark")})</script><link rel=stylesheet href=/css/style.min.40a5b40db9116d5bb60435216d5316fc2c5529b85f32df977c05c417161e21f7.css integrity="sha256-QKW0DbkRbVu2BDUhbVMW/CxVKbhfMt+XfAXEFxYeIfc="><script src=/js/script.min.a65afe903825231554d9b55b073eb144da4ccf2d2823b216dcbc6cc656c9de76.js type=text/javascript integrity="sha256-plr+kDglIxVU2bVbBz6xRNpMzy0oI7IW3LxsxlbJ3nY="></script><meta property="og:title" content="Patching the kernel as a custom package in Archlinux"><meta property="og:description" content="Following the adventure of patching the linux kernel, I tried to automate it a bit. Part of the process is well documented as always in the wiki
The idea is to fetch the official Archlinux sources for the linux kernel so we can modify them and add our patches.
  Could I buy a graphics card with a normal HDMI port for a hundred bucks and skip all of this mess?"><meta property="og:type" content="article"><meta property="og:url" content="https://manueljimenezs.github.io/2022/11/patching-the-kernel-as-a-custom-package-in-archlinux/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-11-06T00:00:00+00:00"><meta property="article:modified_time" content="2022-11-06T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Patching the kernel as a custom package in Archlinux"><meta name=twitter:description content="Following the adventure of patching the linux kernel, I tried to automate it a bit. Part of the process is well documented as always in the wiki
The idea is to fetch the official Archlinux sources for the linux kernel so we can modify them and add our patches.
  Could I buy a graphics card with a normal HDMI port for a hundred bucks and skip all of this mess?"></head><body><a class=skip-main href=#main>Skip to main content</a><div class=container><header class=common-header><div class=header-top><span class=site-logo><a href=/><svg height="30" viewBox="0 0 655 389" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:serif="http://www.serif.com/" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2"><g id="layer1" transform="matrix(1,0,0,1,730.269,231.964)"><path id="path890" d="M-531.765-231.962C-532.739-231.955-533.717-231.932-534.694-231.89V-231.888C-564.056-230.636-590.585-214.002-604.5-188.117-618.414-162.231-617.657-130.927-602.504-105.745l32.078 55.058C-570.476-50.698-570.517-50.717-570.566-50.728c15.383 34.082-12.39 57.859-41.326 48.316C-622.593-7.084-635.12-10.49-647.416-10.525-693.175-10.525-730.269 26.572-730.269 72.332c0 45.76 37.0940000000001 82.857 82.853 82.858C-607.774 155.179-573.695 127.087-566.115 88.176c7-37.986 56.139-38.436 68.289-14.037L-497.713 74.109l22.422 38.486c22.838 40.422 74.318 54.365 114.433 30.992 40.114-23.372 53.372-75.035 29.469-114.836l-32.857-56.396C-374.139-55.314-339.589-67.769-326.721-50.702l95.268 165.01c22.65 40.566 74.114 54.753 114.351 31.524 40.238-23.229 53.686-74.891 29.883-114.791L-214.438-189.301c-15.28-27.351-44.617-43.811-75.924-42.6C-323.078-230.588-350.056-209.372-364.246-179.864-373.238-161.166-390.741-155.566-408.834-155.553-425.341-155.561-440.693-163.221-450.645-175.934L-458.602-189.59c-14.908-26.437-42.966-42.601-73.162-42.371L-531.765-231.962z" style="fill-rule:nonzero"/></g></svg></a></span><ul class=social-icons></ul><nav><input type=checkbox id=nav-trigger class=nav-trigger>
<label for=nav-trigger><span class=menu-icon><svg viewBox="0 0 18 15" width="18" height="15"><path d="M18 1.484c0 .82-.665 1.484-1.484 1.484H1.484C.665 2.969.0 2.304.0 1.484.0.665.665.0 1.484.0h15.032C17.335.0 18 .665 18 1.484zm0 6.032C18 8.335 17.335 9 16.516 9H1.484C.665 9 0 8.335.0 7.516c0-.82.665-1.484 1.484-1.484h15.032C17.335 6.031 18 6.696 18 7.516zm0 6C18 14.335 17.335 15 16.516 15H1.484C.665 15 0 14.335.0 13.516c0-.82.665-1.483 1.484-1.483h15.032C17.335 12.031 18 12.695 18 13.516z"/></svg></span></label><div class=trigger><script>const STORAGE_KEY="user-color-scheme",defaultTheme="auto-without-switcher";let currentTheme,switchButton,autoDefinedScheme=window.matchMedia("(prefers-color-scheme: dark)");const autoChangeScheme=e=>{currentTheme=e.matches?"dark":"light",document.documentElement.setAttribute("data-theme",currentTheme),changeButtonText()};document.addEventListener("DOMContentLoaded",function(){switchButton=document.querySelector(".theme-switcher"),currentTheme=detectCurrentScheme(),currentTheme=="dark"&&document.documentElement.setAttribute("data-theme","dark"),currentTheme=="auto"&&(autoChangeScheme(autoDefinedScheme),autoDefinedScheme.addListener(autoChangeScheme)),switchButton&&(changeButtonText(),switchButton.addEventListener("click",switchTheme,!1)),showContent()});function detectCurrentScheme(){return localStorage.getItem(STORAGE_KEY)?localStorage.getItem(STORAGE_KEY):defaultTheme?defaultTheme:window.matchMedia?window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light":"light"}function changeButtonText(e){e&&(e.textContent=currentTheme=="dark"?"Light theme":"Toggle theme")}function switchTheme(){currentTheme=="dark"?(localStorage.setItem(STORAGE_KEY,"light"),document.documentElement.setAttribute("data-theme","light"),currentTheme="light"):(localStorage.setItem(STORAGE_KEY,"dark"),document.documentElement.setAttribute("data-theme","dark"),currentTheme="dark"),changeButtonText()}function showContent(){document.body.style.visibility="visible",document.body.style.opacity=1}</script><a href=/tags/ title>Tags</a>
<a href=/archive/ title>Archive</a></div></nav></div></header><main id=main tabindex=-1><article class="post h-entry"><div class=post-header><header><h1 class="p-name post-title">Patching the kernel as a custom package in Archlinux</h1></header></div><div class="content e-content"><p><a href=https://manueljimenezs.github.io/2021/09/how-i-ended-up-compiling-my-own-linux-kernel/>Following the adventure of patching the linux kernel</a>, I tried to automate it a bit. Part of the process is well documented as always in the <a href=https://wiki.archlinux.org/title/Kernel/Arch_Build_System>wiki</a></p><p>The idea is to fetch the official Archlinux sources for the linux kernel so we can modify them and add our patches.</p><div class="notice info"><span class="icon info"><object data=/icons/info.svg width=20 height=20></object></span><p>Could I buy a graphics card with a normal HDMI port for a hundred bucks and skip all of this mess? Yes, but where is the fun in that?</p></div><p>Start by creating a new src folder in your homedir.</p><p>We will need the <code>asp</code> package that will take care of fetching the sources for us by issuing these commands:</p><pre tabindex=0><code>asp update
asp export linux
</code></pre><p>I will also add my custom kernel patches in a <code>patches/*.diff</code> dir, you can see
<a href=https://manueljimenezs.github.io/2021/09/how-i-ended-up-compiling-my-own-linux-kernel/>why I need to patch the kernel here</a></p><p>There is also another issue here: the config for the kernel issued by asp is different than the upstream package, meaning that we will need to modify it, otherwise my system, which is a BTRFS filesystem, will not boot:</p><pre tabindex=0><code>cd linux
mv config config.old
sed -r &#34;s/^(|#)CONFIG_BTRFS_FS=.*/CONFIG_BTRFS_FS=y/g&#34; config.old &gt; config
</code></pre><p>I also built a PKGBUILD patch with e.g <code>diff -Naru PKGBUILD PKGBUILD.old > custom_PKGBUILD.patch</code> to apply it on each kernel release, this gets rid of building the docs and their dependencies, also does a shallow clone and introduces my <code>0001-amdgpu-clock.patch</code> patchfile. That way the build will take less time:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-patch data-lang=patch><span class=line><span class=cl><span class=gd>--- PKGBUILD	2022-10-29 12:28:27.038231602 +0200
</span></span></span><span class=line><span class=cl><span class=gd></span><span class=gi>+++ PKGBUILD	2022-10-29 12:28:27.038231602 +0200
</span></span></span><span class=line><span class=cl><span class=gi></span><span class=gu>@@ -1,6 +1,6 @@
</span></span></span><span class=line><span class=cl><span class=gu></span> # Maintainer: Jan Alexander Steffens (heftig) &lt;heftig@archlinux.org&gt;
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=gd>-pkgbase=linux
</span></span></span><span class=line><span class=cl><span class=gd></span><span class=gi>+pkgbase=linux-amdclock
</span></span></span><span class=line><span class=cl><span class=gi></span> pkgver=6.0.5.arch1
</span></span><span class=line><span class=cl> pkgrel=1
</span></span><span class=line><span class=cl> pkgdesc=&#39;Linux&#39;
</span></span><span class=line><span class=cl><span class=gu>@@ -10,14 +10,13 @@
</span></span></span><span class=line><span class=cl><span class=gu></span> license=(GPL2)
</span></span><span class=line><span class=cl> makedepends=(
</span></span><span class=line><span class=cl>   bc libelf pahole cpio perl tar xz
</span></span><span class=line><span class=cl><span class=gd>-  xmlto python-sphinx python-sphinx_rtd_theme graphviz imagemagick texlive-latexextra
</span></span></span><span class=line><span class=cl><span class=gd></span>   git
</span></span><span class=line><span class=cl> )
</span></span><span class=line><span class=cl> options=(&#39;!strip&#39;)
</span></span><span class=line><span class=cl> _srcname=archlinux-linux
</span></span><span class=line><span class=cl> source=(
</span></span><span class=line><span class=cl><span class=gd>-  &#34;$_srcname::git+https://github.com/archlinux/linux?signed#tag=$_srctag&#34;
</span></span></span><span class=line><span class=cl><span class=gd></span>   config         # the main kernel config file
</span></span><span class=line><span class=cl><span class=gi>+  0001-amdgpu-clock.patch
</span></span></span><span class=line><span class=cl><span class=gi></span> )
</span></span><span class=line><span class=cl> validpgpkeys=(
</span></span><span class=line><span class=cl>   &#39;ABAF11C65A2970B130ABE3C479BE3E4300411886&#39;  # Linus Torvalds
</span></span><span class=line><span class=cl><span class=gu>@@ -26,13 +25,14 @@
</span></span></span><span class=line><span class=cl><span class=gu></span>   &#39;C7E7849466FE2358343588377258734B41C31549&#39;  # David Runge &lt;dvzrv@archlinux.org&gt;
</span></span><span class=line><span class=cl> )
</span></span><span class=line><span class=cl> sha256sums=(&#39;SKIP&#39;
</span></span><span class=line><span class=cl><span class=gd>-            &#39;05168cbbeb6378eec6c84fe3300cede4fa5cf6130c39fb8af95040529bd390a6&#39;)
</span></span></span><span class=line><span class=cl><span class=gd></span><span class=gi>+            &#39;SKIP&#39;)
</span></span></span><span class=line><span class=cl><span class=gi></span> 
</span></span><span class=line><span class=cl> export KBUILD_BUILD_HOST=archlinux
</span></span><span class=line><span class=cl> export KBUILD_BUILD_USER=$pkgbase
</span></span><span class=line><span class=cl> export KBUILD_BUILD_TIMESTAMP=&#34;$(date -Ru${SOURCE_DATE_EPOCH:+d @$SOURCE_DATE_EPOCH})&#34;
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> prepare() {
</span></span><span class=line><span class=cl><span class=gi>+  git clone --depth=1 --branch=$_srctag &#34;https://github.com/archlinux/linux&#34; $_srcname
</span></span></span><span class=line><span class=cl><span class=gi></span>   cd $_srcname
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>   echo &#34;Setting version...&#34;
</span></span><span class=line><span class=cl><span class=gu>@@ -60,7 +60,7 @@
</span></span></span><span class=line><span class=cl><span class=gu></span> 
</span></span><span class=line><span class=cl> build() {
</span></span><span class=line><span class=cl>   cd $_srcname
</span></span><span class=line><span class=cl><span class=gd>-  make htmldocs all
</span></span></span><span class=line><span class=cl><span class=gd></span><span class=gi>+  make all
</span></span></span><span class=line><span class=cl><span class=gi></span> }
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> _package() {
</span></span></code></pre></div><p>That patch is then applied like this: <code>patch -p0 &lt; ../custom_PKGBUILD.patch</code></p><p>Now the only thing left is to build and install it:</p><pre tabindex=0><code>makepkg -s
sudo pacman -U linux-amdclock-*.zst
</code></pre><p>You can bundle all of it in a shell script to save time in further upgrades:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=cp>#!/bin/bash
</span></span></span><span class=line><span class=cl><span class=cp></span>rm -rf linux
</span></span><span class=line><span class=cl>asp update
</span></span><span class=line><span class=cl>asp <span class=nb>export</span> linux
</span></span><span class=line><span class=cl>cp patches/* linux
</span></span><span class=line><span class=cl><span class=nb>cd</span> linux
</span></span><span class=line><span class=cl>mv config config.old
</span></span><span class=line><span class=cl><span class=c1># enable support for / as BTRFS filesystem</span>
</span></span><span class=line><span class=cl>sed -r <span class=s2>&#34;s/^(|#)CONFIG_BTRFS_FS=.*/CONFIG_BTRFS_FS=y/g&#34;</span> config.old &gt; config
</span></span><span class=line><span class=cl>patch -p0 &lt; ../custom_PKGBUILD.patch
</span></span></code></pre></div></div><div class=post-info><div class="post-date dt-published">Nov 06, 2022</div><a class="post-hidden-url u-url" href=https://manueljimenezs.github.io/2022/11/patching-the-kernel-as-a-custom-package-in-archlinux/>https://manueljimenezs.github.io/2022/11/patching-the-kernel-as-a-custom-package-in-archlinux/</a>
<a href=https://manueljimenezs.github.io/ class="p-name p-author post-hidden-author h-card" rel=me>Manu</a><div class=post-taxonomies><ul class=post-categories><li><a href=/categories/howto/>howto</a></li></ul><ul class=post-tags><li><a href=/tags/archlinux/>#archlinux</a></li><li><a href=/tags/kernel/>#kernel</a></li></ul></div></div></article><h3 class=read-next-title>Read next</h3><ul class=read-next-posts><li><a href=/2021/09/how-i-ended-up-compiling-my-own-linux-kernel/>How I ended up compiling my own Linux kernel</a></li></ul></main><footer class=common-footer><div class=links><a href=/index.xml><span class=inline-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentcolor" d="M128.081 415.959c0 35.369-28.672 64.041-64.041 64.041S0 451.328.0 415.959s28.672-64.041 64.041-64.041 64.04 28.673 64.04 64.041zm175.66 47.25c-8.354-154.6-132.185-278.587-286.95-286.95C7.656 175.765.0 183.105.0 192.253v48.069c0 8.415 6.49 15.472 14.887 16.018 111.832 7.284 201.473 96.702 208.772 208.772.547 8.397 7.604 14.887 16.018 14.887h48.069c9.149.001 16.489-7.655 15.995-16.79zm144.249.288C439.596 229.677 251.465 40.445 16.503 32.01 7.473 31.686.0 38.981.0 48.016v48.068c0 8.625 6.835 15.645 15.453 15.999 191.179 7.839 344.627 161.316 352.465 352.465.353 8.618 7.373 15.453 15.999 15.453h48.068c9.034-.001 16.329-7.474 16.005-16.504z"/></svg></span></a><a href=https://linkedin.com/in/manueljimenezs><span class=inline-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentcolor" d="M416 32H31.9C14.3 32 0 46.5.0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6.0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3.0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2.0 38.5 17.3 38.5 38.5.0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6.0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2.0 79.7 44.3 79.7 101.9V416z"/></svg></span></a><a href=https://github.com/manueljimenezs><span class=inline-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentcolor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6.0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6.0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3.0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1.0-6.2-.3-40.4-.3-61.4.0.0-70 15-84.7-29.8.0.0-11.4-29.1-27.8-36.6.0.0-22.9-15.7 1.6-15.4.0.0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5.0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9.0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4.0 33.7-.3 75.4-.3 83.6.0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6.0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9.0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg></span></a></div><div class=common-footer-bottom><div class=copyright><p>© Manu, 2025<br></p></div></div><p class="h-card vcard"><a href=https://manueljimenezs.github.io/ class="p-name u-url url fn" rel=me>Manu</a></p></footer></div></body></html>